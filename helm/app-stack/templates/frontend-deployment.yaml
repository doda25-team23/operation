{{- $root := . -}}
{{- $versions := .Values.frontend.versions | default dict -}}

{{- if not (empty $versions) -}}
{{- range $name, $ver := $versions }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sms-app.fullname" $root }}-frontend-{{ $name }}
  namespace: {{ $root.Values.namespace }}
  labels:
    {{- include "sms-app.labels" $root | nindent 4 }}
    app: {{ $root.Values.frontend.service.name }}
spec:
  replicas: {{ $ver.replicaCount | default $root.Values.frontend.replicaCount }}
  selector:
    matchLabels:
      {{- include "sms-app.frontend.selectorLabels" $root | nindent 6 }}
      version: {{ $name }}
  template:
    metadata:
      labels:
        {{- include "sms-app.frontend.selectorLabels" $root | nindent 8 }}
        version: {{ $name }}
    spec:
      {{- if $root.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml $root.Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: frontend
          image: "{{ ($ver.image.repository | default $root.Values.frontend.image.repository) }}:{{ ($ver.image.tag | default $root.Values.frontend.image.tag) }}"
          imagePullPolicy: {{ $root.Values.frontend.image.pullPolicy }}
          ports:
            - containerPort: {{ $root.Values.frontend.service.targetPort }}
              name: http
              protocol: TCP
          env:
            - name: MODEL_HOST
              value: {{ include "sms-app.modelServiceUrl" $root | quote }}
            - name: APP_VERSION
              value: {{ $ver.appVersionEnv | default $name | quote }}
          envFrom:
            - configMapRef:
                name: {{ include "sms-app.fullname" $root }}-config
          resources:
          {{- toYaml $root.Values.frontend.resources | nindent 10 }}
        {{- if $root.Values.frontend.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: {{ $root.Values.frontend.livenessProbe.path }}
              port: {{ $root.Values.frontend.livenessProbe.port }}
            initialDelaySeconds: {{ $root.Values.frontend.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ $root.Values.frontend.livenessProbe.periodSeconds }}
        {{- end }}
        {{- if $root.Values.frontend.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: {{ $root.Values.frontend.readinessProbe.path }}
              port: {{ $root.Values.frontend.readinessProbe.port }}
            initialDelaySeconds: {{ $root.Values.frontend.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ $root.Values.frontend.readinessProbe.periodSeconds }}
        {{- end }}
---
{{- end }}
{{- else }}
# Backwards-compat (single deployment) â€“ keep your old behavior if versions not defined
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sms-app.fullname" . }}-frontend
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "sms-app.labels" . | nindent 4 }}
    app: {{ .Values.frontend.service.name }}
spec:
  replicas: {{ .Values.frontend.replicaCount }}
  selector:
    matchLabels:
      {{- include "sms-app.frontend.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "sms-app.frontend.selectorLabels" . | nindent 8 }}
        version: {{ .Values.frontend.version | default "v1" }}
    spec:
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: frontend
          image: "{{ .Values.frontend.image.repository }}:{{ .Values.frontend.image.tag }}"
          imagePullPolicy: {{ .Values.frontend.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.frontend.service.targetPort }}
              name: http
              protocol: TCP
          env:
            - name: MODEL_HOST
              value: {{ include "sms-app.modelServiceUrl" . | quote }}
            - name: APP_VERSION
              value: {{ .Values.frontend.version | default "v1" | quote }}
          envFrom:
            - configMapRef:
                name: {{ include "sms-app.fullname" . }}-config
{{- end }}
