{{- $root := . -}}
{{- $versions := .Values.modelService.versions | default dict -}}

{{- if not (empty $versions) -}}
{{- range $name, $ver := $versions }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sms-app.fullname" $root }}-model-service-{{ $name }}
  namespace: {{ $root.Values.namespace }}
  labels:
    {{- include "sms-app.labels" $root | nindent 4 }}
    app: {{ $root.Values.modelService.service.name }}
spec:
  replicas: {{ $ver.replicaCount | default $root.Values.modelService.replicaCount }}
  selector:
    matchLabels:
      {{- include "sms-app.modelService.selectorLabels" $root | nindent 6 }}
      version: {{ $name }}
  template:
    metadata:
      labels:
        {{- include "sms-app.modelService.selectorLabels" $root | nindent 8 }}
        version: {{ $name }}
    spec:
      {{- if $root.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml $root.Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: model-service
          image: "{{ ($ver.image.repository | default $root.Values.modelService.image.repository) }}:{{ ($ver.image.tag | default $root.Values.modelService.image.tag) }}"
          imagePullPolicy: {{ $root.Values.modelService.image.pullPolicy }}
          ports:
            - containerPort: {{ $root.Values.modelService.service.targetPort }}
              name: http
              protocol: TCP
          env:
            - name: MODEL_DIR
              value: {{ $root.Values.modelService.model.dir | default "/app/model" | quote }}
          resources:
          {{- toYaml $root.Values.modelService.resources | nindent 10 }}
---
{{- end }}
{{- else }}
# Backwards-compat single deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sms-app.fullname" . }}-model-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "sms-app.labels" . | nindent 4 }}
    app: {{ .Values.modelService.service.name }}
spec:
  replicas: {{ .Values.modelService.replicaCount }}
  selector:
    matchLabels:
      {{- include "sms-app.modelService.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "sms-app.modelService.selectorLabels" . | nindent 8 }}
        version: {{ .Values.modelService.version | default "v1" }}
    spec:
      containers:
        - name: model-service
          image: "{{ .Values.modelService.image.repository }}:{{ .Values.modelService.image.tag }}"
{{- end }}
