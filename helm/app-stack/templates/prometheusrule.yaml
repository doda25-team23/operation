{{- if .Values.alerting.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "app-stack.fullname" . }}-rules
  labels:
    {{- include "app-stack.labels" . | nindent 4 }}
    {{- with .Values.monitoring.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
  - name: application.rules
    interval: 30s
    rules:
    - alert: HighRequestRate
      # This alert fires when the request rate exceeds 15 requests per minute for 2 minutes
      # Uses Spring Boot Actuator metric: http_server_requests_seconds_count
      # Falls back to standard Prometheus metric if Actuator metric not available
      expr: |
        (
          sum(rate(http_server_requests_seconds_count[1m])) by (instance, job)
          or
          sum(rate(http_requests_total[1m])) by (instance, job)
        ) > 15
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High request rate detected"
        description: "Service is receiving more than 15 requests per minute for 2 minutes straight. Current rate: {{ "{{ $value }}"}} req/min. Instance: {{ "{{ $labels.instance }}"}}, Job: {{ "{{ $labels.job }}"}}"
{{- end }}

